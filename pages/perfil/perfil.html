<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usuário</title>
    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
        integrity="sha512-123455667890=" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/public/perfil.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Marketing Place</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <div>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Página Inicial</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/minhasPublicacoes">Minhas Publicações</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/perfil">Perfil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">Sair</a>
                    </li>  
                </ul>
            </div>
            <div>
                <form class="form-inline ml-auto" id="busca">
                    <input class="form-control mr-sm-2" type="search" placeholder="Buscar" aria-label="Buscar">
                    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Buscar</button>
                </form>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <h1>Perfil do Usuário</h1>
        <form id="editarForm" action="/editar-nome" method="POST">
            <div class="form-group">
                <label for="nome">Nome:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="nome" name="nome" value="" required disabled>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-primary" onclick="habilitarEdicao('nome')">Editar Nome</button>
                    </div>
                </div>
                <button type="submit" class="btn btn-success mt-2" style="display: none;">Salvar</button>
            </div>
        </form>

        <form id="editarEmailForm" action="/editar-email" method="POST">
            <div class="form-group">
                <label for="email">Email:</label>
                <div class="input-group">
                    <input type="email" class="form-control" id="email" name="email" value="" required disabled>
                    <div class="input-group-append">
                        <button type="button" class="btn btn-primary" onclick="habilitarEdicao('email')">Editar Email</button>
                    </div>
                </div>
                <button type="submit" class="btn btn-success mt-2" style="display: none;">Salvar</button>
            </div>
        </form>

        <p>Data de Cadastro: <span id="dataCadastro"></span></p>

        <!-- Modal para mudança de senha -->
        <div id="editarSenhaModal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Senha</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editarSenhaForm" action="/editar-senha" method="POST">
                            <div class="form-group">
                                <label for="senhaAtual">Senha Atual:</label>
                                <input type="password" class="form-control" id="senhaAtual" name="senhaAtual" required>
                            </div>
                            <div class="form-group">
                                <label for="novaSenha">Nova Senha:</label>
                                <input type="password" class="form-control" id="novaSenha" name="novaSenha" required>
                            </div>
                            <button type="submit" class="btn btn-success">Salvar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <form id="excluirForm" action="/excluir-conta" method="POST" class="mt-3">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Tem certeza que deseja excluir sua conta?')">Excluir Conta</button>
            <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#editarSenhaModal">Mudar Senha</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/usuario');
                const usuario = await response.json();

                if (response.ok) {
                    document.getElementById('nome').value = usuario.Nome;
                    document.getElementById('email').value = usuario.Email;

                    const dataCadastro = new Date(usuario.Data_Cadastro);
                    if (!isNaN(dataCadastro.getTime())) {
                        const dia = String(dataCadastro.getDate()).padStart(2, '0');
                        const mes = String(dataCadastro.getMonth() + 1).padStart(2, '0');
                        const ano = dataCadastro.getFullYear();
                        const dataFormatada = `${dia}/${mes}/${ano}`;
                        document.getElementById('dataCadastro').textContent = dataFormatada;
                    } else {
                        console.error('Data de cadastro inválida:', usuario.Data_Cadastro);
                        document.getElementById('dataCadastro').textContent = 'Data de cadastro inválida';
                    }
                } else {
                    console.error('Erro ao carregar dados do perfil:', response.status);
                    throw new Error('Erro ao carregar dados do perfil');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                alert('Erro na requisição. Por favor, tente novamente mais tarde.');
            }
        });

        function logout() {
            fetch('/logout', {
                method: 'POST',
                credentials: 'include', // Envia cookies com a requisição
            })
            .then(response => {
                if (response.ok) {
                    // Redireciona para a página de login ou inicial
                    window.location.href = '/login';
                } else {
                    alert('Erro ao fazer logout. Tente novamente.');
                }
            })
            .catch(error => {
                console.error('Erro na requisição de logout:', error);
                alert('Erro na requisição. Por favor, tente novamente mais tarde.');
            });
        }

        function habilitarEdicao(campo) {
            const campoInput = document.getElementById(campo);
            campoInput.removeAttribute('disabled');
            const salvarButton = campoInput.parentElement.querySelector('button[type="submit"]');
            salvarButton.style.display = 'block';
        }

        function abrirEditarSenhaModal() {
            document.getElementById('editarSenhaModal').style.display = 'block';
        }

        function fecharEditarSenhaModal() {
            document.getElementById('editarSenhaModal').style.display = 'none';
        }
    </script>
</body>
</html>
